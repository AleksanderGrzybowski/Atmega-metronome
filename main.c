#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <stdbool.h>


// Interrupts using 16-bit Timer1
void setup_interrupt() {
    // no prescaler
    TCCR1B &= ~(1 << CS11);
    TCCR1B |= (1 << CS10) | (1 << CS12);
    TIMSK0 |= (1 << TOIE1) | (1 << TOIE0); // enable overflow interrupt
    sei(); // enable global interrupts
}


void disable_jtag() {
    //MCUCSR |= (1 << JTD);
    //MCUCSR |= (1 << JTD);
}

void setup() {
    setup_interrupt();
    disable_jtag();
}



int buzzing = 0;
int cnt = 0;
ISR(TIMER0_OVF_vect) {
    if (buzzing) {
        OCR0A = 128;
        cnt++;
        if (cnt > 10) {
            OCR0A = 0;
            buzzing = false;
            cnt = 0;
        }
    }
}

uint16_t bpm[] = { 46875,44643,42614,40761,39063,37500,36058,34722,33482,32328,31250,30242,29297,28409,27574,26786,26042,25338,24671,24038,23438,22866,22321,21802,21307,20833,20380,19947,19531,19133,18750,18382,18029,17689,17361,17045,16741,16447,16164,15890,15625,15369,15121,14881,14648,14423,14205,13993,13787,13587,13393,13204,13021,12842,12669,12500,12336,12175,12019,11867,11719,11574,11433,11295,11161,11029,10901,10776,10653,10534,10417,10302,10190,10081,9973,9868,9766,9665,9566,9470,9375,9282,9191,9102,9014,8929,8844,8762,8681,8601,8523,8446,8371,8296,8224,8152,8082,8013,7945,7878,7813,7748,7684,7622,7560,7500,7440,7382,7324,7267,7212,7156,7102,7049,6996,6944,6893,6843,6793,6745,6696,6649,6602,6556,6510,6466,6421,6378,6334,6292,6250,6209,6168,6127,6088,6048,6010,5971,5934,5896,5859,5823,5787,5752,5716,5682,5648,5614,5580,5547,5515,5482,5451,5419,5388,5357,5327,5297,5267,5237,5208,5180,5151,5123,5095,5068,5040,5013,4987,4960,4934,4908,4883,4858,4832,4808,4783,4759,4735,4711,4688 };

int current_bpm = 60;
ISR(TIMER1_OVF_vect) { // here
    PORTC ^= (1 << PC0);
    TCNT1 = 65536 - bpm[current_bpm-20];
    buzzing = 1;
}


int main(void) {
    setup();

    DDRC = 0xff;

    OCR1A = 128;
    char buf[10];

    while(1) {
        PORTC ^= 0xff;
        _delay_ms(1000);
    }
}
