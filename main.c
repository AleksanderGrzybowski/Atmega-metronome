#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <stdbool.h>


// Interrupts using 16-bit Timer1
void setup_interrupt() {
    // no prescaler
    TCCR1B &= ~(1 << CS11);
    TCCR1B |= (1 << CS10) | (1 << CS12);
    TIMSK1 |= (1 << TOIE1); // TODO do 0 too
    sei(); // enable global interrupts
}


void disable_jtag() {
    //MCUCSR |= (1 << JTD);
    //MCUCSR |= (1 << JTD);
}

void setup() {
    setup_interrupt();
    disable_jtag();
}



int buzzing = 0;
int cnt = 0;
ISR(TIMER0_OVF_vect) {
    /*if (buzzing) {
        OCR0A = 128;
        cnt++;
        if (cnt > 10) {
            OCR0A = 0;
            buzzing = false;
            cnt = 0;
        }
    }*/

}

uint16_t bpm[] = { 11719,11161,10654,10190,9766,9375,9015,8681,8371,8082,7813,7561,7324,7102,6894,6697,6511,6335,6168,6010,5860,5717,5580,5451,5327,5208,5095,4987,4883,4783,4688,4596,4507,4422,4340,4261,4185,4112,4041,3973,3906,3842,3780,3720,3662,3606,3551,3498,3447,3397,3348,3301,3255,3211,3167,3125,3084,3044,3005,2967,2930,2894,2858,2824,2790,2757,2725,2694,2663,2634,2604,2576,2548,2520,2493,2467,2442,2416,2392,2368,2344,2321,2298,2276,2254,2232,2211,2191,2170,2150,2131,2112,2093,2074,2056,2038,2021,2003,1986,1970,1953,1937,1921,1906,1890,1875,1860,1846,1831,1817,1803,1789,1776,1762,1749,1736,1723,1711,1698,1686,1674,1662,1651,1639,1628,1617,1605,1595,1584,1573,1563,1552,1542,1532,1522,1512,1503,1493,1484,1474,1465,1456,1447,1438,1429,1421,1412,1404,1395,1387,1379,1371,1363,1355,1347,1339,1332,1324,1317,1309,1302,1295,1288,1281,1274,1267,1260,1253,1247,1240,1234,1227,1221,1215,1208,1202,1196,1190,1184,1178,1172 };

int current_bpm = 60;
ISR(TIMER1_OVF_vect) { // here

    PORTC ^= 0xff;
    PORTC ^= (1 << PC0);
    TCNT1 = 65536 - bpm[current_bpm-20];
    buzzing = 1;
}


int main(void) {
    setup();

    DDRC = 0xff;

    OCR1A = 128;
    char buf[10];
    TCNT1 = 65530;

    while(1) {
    }
}
